<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <title>Düğün Ekle – WedSystem</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      --bg: #020617;
      --card: #020617;
      --border: #1e293b;
      --fg: #e5e7eb;
      --muted: #9ca3af;
      --brand: #8b5cf6;
      --brand2: #06b6d4;
      --danger: #ef4444;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: radial-gradient(circle at top left, rgba(139,92,246,.25), transparent 55%),
                  radial-gradient(circle at bottom right, rgba(6,182,212,.28), transparent 55%),
                  var(--bg);
      color: var(--fg);
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 24px;
    }
    .shell {
      width: 100%;
      max-width: 720px;
    }
    .login-shell {
      width: 100%;
      max-width: 420px;
    }
    .card {
      background: rgba(15,23,42,.96);
      border-radius: 18px;
      border: 1px solid rgba(148,163,184,.28);
      padding: 20px 20px 18px;
      box-shadow: 0 24px 60px rgba(15,23,42,.9);
      backdrop-filter: blur(14px);
    }
    .title {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      margin-bottom: 12px;
    }
    .title h1 {
      margin: 0;
      font-size: 22px;
      background: linear-gradient(135deg, var(--brand), var(--brand2));
      -webkit-background-clip: text;
      background-clip: text;
      color: transparent;
    }
    .badge {
      padding: 4px 10px;
      border-radius: 999px;
      border: 1px solid rgba(148,163,184,.4);
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: .08em;
      color: var(--muted);
    }
    .muted { color: var(--muted); font-size: 13px; }

    .grid {
      display: grid;
      grid-template-columns: minmax(0, 1.2fr) minmax(0, 1fr);
      gap: 16px;
      margin-top: 14px;
    }
    @media (max-width: 640px) {
      .grid { grid-template-columns: minmax(0, 1fr); }
    }

    label { display: block; font-size: 13px; margin-bottom: 4px; color: #e5e7eb; }
    input {
      width: 100%;
      padding: 9px 11px;
      border-radius: 12px;
      border: 1px solid rgba(148,163,184,.5);
      background: rgba(15,23,42,.9);
      color: var(--fg);
      outline: none;
      font-size: 14px;
      transition: border-color .16s ease, box-shadow .16s ease, background .16s ease;
    }
    input:focus {
      border-color: rgba(139,92,246,.9);
      box-shadow: 0 0 0 1px rgba(139,92,246,.9);
      background: #020617;
    }

    button {
      font-family: inherit;
      cursor: pointer;
    }
    .btn-primary {
      border-radius: 999px;
      border: 0;
      padding: 9px 16px;
      font-size: 14px;
      font-weight: 600;
      color: white;
      background: linear-gradient(135deg, var(--brand), var(--brand2));
      box-shadow: 0 16px 40px rgba(79,70,229,.6);
      display: inline-flex;
      align-items: center;
      gap: 6px;
      transition: transform .15s ease, box-shadow .15s ease, filter .15s ease;
    }
    .btn-primary:hover {
      transform: translateY(-1px);
      filter: brightness(1.05);
      box-shadow: 0 22px 50px rgba(79,70,229,.75);
    }
    .btn-danger {
      border-radius: 999px;
      border: 0;
      padding: 5px 10px;
      font-size: 11px;
      font-weight: 500;
      color: #fecaca;
      background: rgba(127, 29, 29, 0.95);
    }

    .field-row {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .list-wrap {
      background: rgba(15,23,42,.9);
      border-radius: 14px;
      border: 1px solid rgba(30,64,175,.55);
      padding: 10px 10px 6px;
      max-height: 260px;
      overflow: auto;
      font-size: 13px;
    }
    ul#weddingList {
      list-style: none;
      margin: 0;
      padding: 0;
    }
    #weddingList li {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
      padding: 6px 4px;
      border-bottom: 1px solid rgba(30,64,175,.5);
    }
    #weddingList li:last-child { border-bottom: 0; }
    #weddingList code { font-size: 12px; }

    .hint { margin-top: 8px; font-size: 12px; color: var(--muted); }
  </style>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
  <script>
    // Aynı config admin.html ile birebir aynı
    var firebaseConfig = {
      apiKey: "AIzaSyChBoQ1PeASYybsUFyZ_iyCKwCgcq2SLPk",
      authDomain: "wedsystem-e080a.firebaseapp.com",
      databaseURL: "https://wedsystem-e080a-default-rtdb.europe-west1.firebasedatabase.app",
      projectId: "wedsystem-e080a",
      storageBucket: "wedsystem-e080a.firebasestorage.app",
      messagingSenderId: "90318782559",
      appId: "1:90318782559:web:374f51b404735c36151bea",
      measurementId: "G-YBXXF4V5RV"
    };
    if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
    window.db = firebase.firestore();
  </script>
</head>
<body>
  <!-- Sayfa giriş ekranı -->
  <div id="loginScreen" class="login-shell">
    <div class="card">
      <div class="title">
        <h1>Admin Giriş</h1>
        <span class="badge">DüğünSepeti</span>
      </div>
      <p class="muted">Bu sayfa yalnızca sistem yöneticisi içindir.</p>
      <form id="loginForm" class="login-form">
        <div class="field-row">
          <label for="loginUser">Kullanıcı Adı</label>
          <input id="loginUser" autocomplete="username" />
        </div>
        <div class="field-row" style="margin-top:8px;">
          <label for="loginPass">Şifre</label>
          <input id="loginPass" type="password" autocomplete="current-password" />
        </div>
        <div style="margin-top:12px; display:flex; justify-content:flex-end; gap:8px; align-items:center;">
          <span id="loginError" class="muted" style="color:#fecaca;"></span>
          <button type="submit" class="btn-primary">Giriş Yap</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Giriş başarılı olunca açılacak asıl panel -->
  <div class="shell" id="app" style="display:none;">
    <div class="card">
      <div class="title">
        <h1>Düğün Ekle Paneli</h1>
        <span class="badge">Yalnızca iç kullanım</span>
      </div>
      <p class="muted">Buradan <strong>weddings</strong> koleksiyonuna yeni düğün kayıtları ekleyebilirsin. Bu ekran, admin.html içindeki "Düğün Ekle" sisteminin sadeleştirilmiş versiyonudur.</p>

      <div class="grid" style="margin-top: 14px;">
        <div class="field-row">
          <div>
            <label for="newWeddingId">Düğün ID (weddingId)</label>
            <input id="newWeddingId" placeholder="örn: kerem-yagmur" />
          </div>
          <div>
            <label for="newWeddingPassword">Admin Şifre</label>
            <input id="newWeddingPassword" type="password" placeholder="Bu düğüne ait admin şifresi" />
          </div>
          <div style="margin-top: 6px; display:flex; justify-content:flex-start; gap:8px; align-items:center;">
            <button id="addWeddingBtn" class="btn-primary" type="button">
              <span>➕ Düğün Ekle</span>
            </button>
          </div>
          <div class="hint">
            Kayıt Firestore'da <code>weddings/{weddingId}</code> dokümanı olarak açılır. Şifre <code>passwordHash: sha256:&lt;hash&gt;</code> formatında saklanır.
          </div>
        </div>

        <div class="field-row">
          <label>Kayıtlı Düğünler</label>
          <div class="list-wrap">
            <ul id="weddingList">
              <li class="muted">Yükleniyor…</li>
            </ul>
          </div>
          <div class="hint">Silmek için satırdaki <strong>Sil</strong> butonuna bas. Silme işlemi için ayrı bir admin şifresi sorulur.</div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // === admin.js içindekiyle birebir aynı helper'lar (yalnızca Düğün Ekle için gerekenler) ===
    const db = window.db || firebase.firestore();
    const WEDDINGS_COL = 'weddings';

    // Sayfa bazlı giriş için kullanıcı adı ve şifre
    const PAGE_ADMIN_USER = 'Admin';
    const PAGE_ADMIN_PASS = '2773673Ku10837djISUY19D';

    function el(id){ return document.getElementById(id); }
    function esc(s){ return String(s ?? '').replace(/[&<>]/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;'}[c])); }

    async function sha256Hex(str){
      const enc = new TextEncoder().encode(str);
      const buf = await crypto.subtle.digest('SHA-256', enc);
      return Array.from(new Uint8Array(buf)).map(b => b.toString(16).padStart(2,'0')).join('');
    }

    async function requireAdminSecret(){
      const input = prompt('Genel admin şifresi (düğün silme için zorunlu):');
      if (!input) return false;
      // Silme işlemi için, sayfaya girişte kullandığın admin şifresi (PAGE_ADMIN_PASS) ile aynı şifreyi istiyoruz.
      if (input === PAGE_ADMIN_PASS) {
        return true;
      } else {
        alert('Admin şifresi hatalı.');
        return false;
      }
    }

    async function addWeddingFirebase(){
      try{
        const id = el('newWeddingId')?.value.trim();
        const pw = el('newWeddingPassword')?.value;
        if (!id || !pw){
          alert('Düğün ID ve şifre zorunlu.');
          return;
        }
        const hash = await sha256Hex(pw);
        await db.collection(WEDDINGS_COL).doc(id).set({
          passwordHash: `sha256:${hash}`,
          createdAt: (firebase.firestore && firebase.firestore.FieldValue)
            ? firebase.firestore.FieldValue.serverTimestamp() : new Date(),
          updatedAt: (firebase.firestore && firebase.firestore.FieldValue)
            ? firebase.firestore.FieldValue.serverTimestamp() : new Date()
        }, { merge: true });
        el('newWeddingPassword').value = '';
        await renderWeddingListFirebase();
        alert('Düğün Firestore\'a eklendi. admin.html içinden bu ID + şifre ile giriş yapabilirsin.');
      }catch(err){
        console.error('addWeddingFirebase error:', err);
        alert('Düğün eklenemedi. Kod: ' + (err.code||err.name) + '\nMesaj: ' + err.message);
      }
    }

    async function renderWeddingListFirebase(){
      const list = el('weddingList');
      if (!list) return;
      try{
        list.innerHTML = '<li class="muted">Yükleniyor…</li>';
        const snap = await db.collection(WEDDINGS_COL).get();
        const ids = [];
        snap.forEach(doc => ids.push(doc.id));
        ids.sort();
        if (!ids.length){
          list.innerHTML = '<li class="muted">(Henüz kayıt yok)</li>';
          return;
        }
        list.innerHTML = '';
        ids.forEach(k => {
          const li = document.createElement('li');
          li.innerHTML = '<code>' + esc(k) + '</code>' +
                         '<button class="btn-danger" data-k="' + esc(k) + '" style="margin-left:8px">Sil</button>';
          list.appendChild(li);
        });
        list.querySelectorAll('.btn-danger').forEach(btn => {
          btn.onclick = async () => {
            try{
              const k = btn.getAttribute('data-k');
              const ok = await requireAdminSecret();
              if (!ok){
                alert('Yetkisiz işlem: Admin şifresi hatalı veya iptal edildi.');
                return;
              }
              if (!confirm(k + ' düğününü silmek istediğine emin misin?')) return;
              await db.collection(WEDDINGS_COL).doc(k).delete();
              renderWeddingListFirebase();
            }catch(err){
              console.error('Wedding delete error:', err);
              alert('Silinemedi. Kod: ' + (err.code||err.name) + '\nMesaj: ' + err.message);
            }
          };
        });
      }catch(err){
        console.error('renderWeddingListFirebase error:', err);
        list.innerHTML = '<li style="color:#fecaca">Listeleme hatası</li>';
        alert('Listeleme hatası. Kod: ' + (err.code||err.name) + '\nMesaj: ' + err.message);
      }
    }

    function setupPageGate(){
      const loginForm = document.getElementById('loginForm');
      const userInput = document.getElementById('loginUser');
      const passInput = document.getElementById('loginPass');
      const loginError = document.getElementById('loginError');
      const loginScreen = document.getElementById('loginScreen');
      const app = document.getElementById('app');

      if (!loginForm || !userInput || !passInput || !loginScreen || !app) return;

      loginForm.addEventListener('submit', function(e){
        e.preventDefault();
        const u = (userInput.value || '').trim();
        const p = passInput.value || '';
        if (u === PAGE_ADMIN_USER && p === PAGE_ADMIN_PASS){
          if (loginError) loginError.textContent = '';
          loginScreen.style.display = 'none';
          app.style.display = '';
          // Girişten sonra listeyi yükle
          renderWeddingListFirebase();
        } else {
          if (loginError) loginError.textContent = 'Kullanıcı adı veya şifre hatalı.';
        }
      });
    }

    document.addEventListener('DOMContentLoaded', function(){
      const addBtn = el('addWeddingBtn');
      if (addBtn) addBtn.addEventListener('click', addWeddingFirebase);
      setupPageGate();
    });
  </script>
</body>
</html>
