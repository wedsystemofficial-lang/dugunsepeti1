<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <title>Admin Paneli — DugunSepeti</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="description" content="DugunSepeti yönetici paneli. RSVP kayıtları ve oturma planını anlık yönetin.">
  <meta property="og:title" content="DugunSepeti — Admin Paneli">
  <meta property="og:description" content="RSVP yanıtlarını canlı görün, oturma planını yönetin. Güvenli, hızlı, modern.">
  <meta property="og:type" content="website">
  <meta property="og:locale" content="tr_TR">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&family=Playfair+Display:wght@600;700&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg:#050815;
      --bg-soft:#0b1020;
      --fg:#f9fafb;
      --muted:#9ca3af;
      --border:#1f2937;
      --accent:#facc15;
      --accent-soft:rgba(250,204,21,0.15);
      --chip-bg:#111827;
    }

    html,body{
      height:100%;
    }

    body{
      margin:0;
      font-family: Inter, system-ui, -apple-system, "Segoe UI", sans-serif;
      color:var(--fg);
      background:#c89595 url("img/landing-bg.jpg") center center / cover fixed no-repeat;
      overflow:hidden; /* Tam ekran app hissi */
    }

    /* Basit karartma layer */
    .bg-overlay{
      position:fixed;
      inset:0;
      background:radial-gradient(circle at 10% 0%, rgb(203, 163, 163), transparent 40%),
                 radial-gradient(circle at 90% 40%, rgba(59,130,246,0.18), transparent 60%),
                 linear-gradient(180deg, rgba(0,0,0,0.80), rgba(0,0,0,0.95));
      pointer-events:none;
      z-index:-1;
    }

    /* ===== NAVBAR ===== */
    .admin-shell{
      display:flex;
      flex-direction:column;
      height:100%;
    }

    .admin-nav{
      height:64px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding:0 24px;
      background:rgb(42, 37, 37);
      border-bottom:1px solid rgba(31,41,55,0.8);
      backdrop-filter:blur(16px) saturate(160%);
    }

    .nav-left{
      display:flex;
      align-items:center;
      gap:12px;
    }

    .brand-logo{
      width:26px;
      height:26px;
      border-radius:9px;
      background:
        radial-gradient(circle at 20% 20%, #fef3c7, #fbbf24),
        radial-gradient(circle at 80% 80%, #7c3aed, #0ea5e9);
      box-shadow:0 0 18px rgba(250,204,21,0.9);
      position:relative;
    }
    .brand-logo::after{
      content:"";
      position:absolute;
      inset:4px;
      border-radius:7px;
      border:1px solid rgba(255,255,255,0.4);
    }

    .brand-text{
      font-weight:800;
      letter-spacing:.05em;
      text-transform:uppercase;
      font-size:13px;
    }

    .nav-menu{
      display:flex;
      align-items:center;
      gap:12px;
      margin-left:32px;
    }

    .nav-link{
      color:var(--muted);
      font-size:14px;
      padding:7px 12px;
      border-radius:999px;
      text-decoration:none;
      border:1px solid transparent;
      transition:all .18s ease;
      background:transparent;
    }
    .nav-link:hover{
      color:var(--fg);
      border-color:rgba(148,163,184,0.6);
      background:rgba(15,23,42,0.9);
    }

    .nav-link.primary{
      color:#111827;
      background:var(--accent);
      border-color:transparent;
      font-weight:600;
      box-shadow:0 12px 30px rgba(250,204,21,0.35);
    }
    .nav-link.primary:hover{
      filter:brightness(1.04);
      transform:translateY(-1px);
    }

    /* Giriş alanı (sağ üst) */
    .nav-login{
      display:flex;
      align-items:center;
      gap:8px;
      background:rgba(15,23,42,0.9);
      padding:6px 10px;
      border-radius:999px;
      border:1px solid rgba(55,65,81,0.9);
    }
    .nav-login label{
      font-size:11px;
      color:var(--muted);
    }
    .nav-login input{
      width:130px;
      font-size:12px;
      padding:6px 8px;
      border-radius:999px;
      border:1px solid rgba(55,65,81,0.9);
      background:#020617;
      color:var(--fg);
      outline:none;
    }
    .nav-login input:focus{
      border-color:var(--accent);
      box-shadow:0 0 0 2px rgba(250,204,21,0.25);
    }
    .nav-login button{
      border-radius:999px;
      border:0;
      padding:6px 12px;
      font-size:12px;
      font-weight:600;
      cursor:pointer;
      background:linear-gradient(135deg,#22c55e,#16a34a);
      color:#ecfdf5;
      box-shadow:0 10px 25px rgba(34,197,94,0.35);
      transition:transform .15s ease, box-shadow .15s ease;
    }
    .nav-login button:hover{
      transform:translateY(-1px);
      box-shadow:0 14px 34px rgba(34,197,94,0.45);
    }

    /* ===== ANA LAYOUT ===== */
    .admin-main{
      flex:1;
      display:flex;
      padding:16px 20px 20px;
      gap:16px;
      box-sizing:border-box;
    }

    /* Masa alanı (sol taraf) */
    .seat-area{
      flex:3;
      min-width:0;
      background:rgba(15,23,42,0.94);
      border-radius:18px;
      border:1px solid rgba(31,41,55,0.95);
      box-shadow:0 20px 50px rgba(0,0,0,0.7);
      padding:18px 18px 14px;
      display:flex;
      flex-direction:column;
      backdrop-filter:blur(18px) saturate(160%);
    }

    .seat-header{
      display:flex;
      align-items:center;
      justify-content:space-between;
      margin-bottom:14px;
    }

    .seat-title{
      font-size:20px;
      font-weight:700;
    }
    .seat-sub{
      font-size:13px;
      color:var(--muted);
    }

    .seat-actions{
      display:flex;
      align-items:center;
      gap:8px;
    }

    .btn{
      font-size:13px;
      padding:8px 11px;
      border-radius:999px;
      border:1px solid rgba(55,65,81,0.9);
      background:rgba(17,24,39,0.9);
      color:var(--fg);
      cursor:pointer;
    }
    .btn.primary{
      border-color:transparent;
      background:linear-gradient(135deg,#38bdf8,#6366f1);
      box-shadow:0 12px 30px rgba(59,130,246,0.45);
    }
    .btn.secondary{
      background:rgba(15,23,42,1);
    }

    .seat-grid-wrapper{
      flex:1;
      border-radius:14px;
      border:1px solid rgba(55,65,81,0.9);
      background:radial-gradient(circle at 10% 10%, rgba(59,130,246,0.12), transparent 55%),
                 radial-gradient(circle at 90% 90%, rgba(16,185,129,0.12), transparent 55%),
                 #020617;
      padding:18px;
      box-sizing:border-box;
      display:flex;
      flex-direction:column;
      gap:10px;
      position:relative;
    }

    /* Masa slotları — tüm alanı dolduran grid */
    #dragArea{
      flex:1;
      position:relative;
      border-radius:14px;
      overflow:hidden;
      background:
        url("salon-krokisi.png") center/contain no-repeat,
        radial-gradient(circle at 10% 10%, rgba(15,23,42,0.9), transparent 55%),
        #020617;
      margin-top:4px;
    }

    #tablesLayer{
      position:absolute;
      inset:0;
    }

    .table-node{
      position:absolute;
      width:72px;
      height:72px;
      border-radius:50%;
      background:#279bf4; /* Lila masa gövdesi */
      border:3px solid #6b21a8; /* Mor çerçeve */
      display:flex;
      align-items:center;
      justify-content:center;
      font-weight:700;
      font-size:14px;
      color:#111827;
      cursor:grab;
      box-shadow:0 14px 30px rgba(15,23,42,0.75);
      user-select:none;
      transition:box-shadow .15s ease, transform .15s ease;
    }

    .table-node.long{
      width:160px;
      height:46px;
      border-radius:14px;
    }

    /* Sandalye sembolleri – yuvarlak masalar için
       (uzun masa sandalyeleriyle aynı stil, dairesel yerleşim) */
    .table-node.round::before {
      content: "";
      position: absolute;
      left: 50%;
      top: 50%;
      width: 10px;
      height: 6px;
      border-radius: 999px;
      background: transparent;
      transform: translate(-50%, -50%);
      pointer-events: none;
      box-shadow:
        /* üst */
        0  -40px 0 #111827,
        /* sağ-üst */
        22px -34px 0 #111827,
        /* sağ */
        36px -12px 0 #111827,
        /* sağ-alt */
        36px  12px 0 #111827,
        /* alt */
        22px  34px 0 #111827,
        0    40px 0 #111827,
        /* sol-alt */
        -22px 34px 0 #111827,
        /* sol */
        -36px 12px 0 #111827,
        /* sol-üst */
        -36px -12px 0 #111827,
        -22px -34px 0 #111827;
    }

    /* Sandalye sembolleri – uzun masalar için (üst ve alt sıra) */
    .table-node.long::before,
    .table-node.long::after {
      content:"";
      position:absolute;
      left:50%;
      width:10px;
      height:6px;
      border-radius:999px; /* ince uzun sandalye formu */
      background:transparent;
      transform:translateX(-50%);
      pointer-events:none;
      box-shadow:
        -42px 0 0 #111827,
        -21px 0 0 #111827,
        0 0 0 #111827,
        21px 0 0 #111827,
        42px 0 0 #111827;
    }
    .table-node.long::before {
      top:-6px;   /* üst sıra sandalyeler */
    }
    .table-node.long::after {
      bottom:-6px; /* alt sıra sandalyeler */
    }

    .table-node:hover{
      transform:translateY(-1px);
      box-shadow:0 18px 40px rgba(15,23,42,0.9);
    }

    .btn.small{
      padding:6px 9px;
      font-size:11px;
    }

    .table-slot{
      position:relative;
      border-radius:16px;
      border:1px dashed rgba(148,163,184,0.65);
      background:rgba(15,23,42,0.9);
      padding:10px;
      overflow:hidden;
      transition:border-color .15s ease, box-shadow .15s ease, transform .15s ease, background .15s ease;
    }

    .table-slot b{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      width:32px;
      height:32px;
      border-radius:999px;
      background:var(--accent-soft);
      border:1px solid rgba(250,204,21,0.7);
      color:var(--accent);
      font-size:13px;
      box-shadow:0 0 18px rgba(250,204,21,0.35);
    }

    .table-slot.is-over{
      border-color:#38bdf8;
      box-shadow:0 0 0 3px rgba(56,189,248,0.36), 0 14px 40px rgba(15,23,42,1);
      transform:translateY(-2px);
      background:radial-gradient(circle at 20% 0%, rgba(56,189,248,0.25), transparent 55%),
                 rgba(15,23,42,0.95);
    }

    .table-guests{
      margin-top:8px;
      display:flex;
      flex-wrap:wrap;
      gap:6px;
    }

    .chip{
      display:inline-flex;
      align-items:center;
      gap:6px;
      padding:5px 9px;
      border-radius:999px;
      background:var(--chip-bg);
      border:1px solid rgba(75,85,99,0.9);
      font-size:11px;
      cursor:grab;
      color: #111827 !important;
    }

    /* Misafir paneli (sağ taraf) */
    .guest-panel{
      flex:2;
      min-width:260px;
      max-width:380px;
      background:rgba(15,23,42,0.96);
      border-radius:18px;
      border:1px solid rgba(31,41,55,0.95);
      box-shadow:0 20px 50px rgba(0,0,0,0.7);
      padding:16px 16px 10px;
      display:flex;
      flex-direction:column;
      backdrop-filter:blur(18px) saturate(160%);
    }

    .guest-panel h2{
      margin:0 0 4px;
      font-size:18px;
    }
    .guest-panel .meta{
      font-size:12px;
      color:var(--muted);
      margin-bottom:10px;
    }

    .guest-filters{
      display:flex;
      flex-wrap:wrap;
      gap:6px;
      margin-bottom:8px;
    }
    .guest-filters select,
    .guest-filters input{
      flex:1;
      min-width:130px;
      font-size:12px;
      padding:6px 8px;
      border-radius:999px;
      border:1px solid rgba(55,65,81,0.9);
      background:#020617;
      color:var(--fg);
      outline:none;
    }
    .guest-filters input:focus,
    .guest-filters select:focus{
      border-color:#38bdf8;
      box-shadow:0 0 0 2px rgba(56,189,248,0.25);
    }

    .guest-actions{
      display:flex;
      align-items:center;
      gap:6px;
      margin-bottom:10px;
    }
    .guest-actions button{
      flex:1;
      font-size:12px;
      padding:7px 8px;
      border-radius:999px;
      border:1px solid rgba(55,65,81,0.9);
      background:rgba(17,24,39,0.95);
      color:var(--fg);
      cursor:pointer;
    }
    .guest-actions button.primary{
      border-color:transparent;
      background:linear-gradient(135deg,#6366f1,#22c55e);
      box-shadow:0 10px 25px rgba(79,70,229,0.45);
    }

    .guest-scroll{
      flex:1;
      border-radius:12px;
      border:1px solid rgba(31,41,55,0.95);
      background:rgba(15,23,42,0.98);
      overflow:auto;
      padding:6px;
    }

    /* Tablo yerine basit chip havuzu + minilist */
    #guestPool{
      margin-bottom:6px;
      min-height:56px;
    }

    #guestTable{
      width:100%;
      border-collapse:collapse;
      font-size:11px;
    }
    #guestTable thead{
      position:sticky;
      top:0;
      background:rgba(15,23,42,1);
      z-index:1;
    }
    #guestTable th,
    #guestTable td{
      padding:5px 6px;
      border-bottom:1px solid rgba(31,41,55,0.85);
      text-align:left;
    }
    #guestTable th{
      font-weight:600;
      color:var(--muted);
      font-size:11px;
    }

    /* WhatsApp davet linki */
    .wa-box{
      margin-top:8px;
      padding:7px 8px;
      border-radius:12px;
      background:rgba(22,101,52,0.12);
      border:1px solid rgba(22,163,74,0.7);
      font-size:11px;
      display:flex;
      align-items:center;
      gap:6px;
    }
    .wa-box button{
      font-size:11px;
      padding:5px 8px;
      border-radius:999px;
      border:0;
      background:linear-gradient(135deg,#22c55e,#16a34a);
      color:#ecfdf5;
      cursor:pointer;
    }

    /* Toast */
    #toast{
      position:fixed;
      bottom:18px;
      right:18px;
      background:rgba(15,23,42,0.98);
      border-radius:12px;
      border:1px solid rgba(55,65,81,0.9);
      padding:9px 12px;
      font-size:13px;
      opacity:0;
      transform:translateY(10px);
      pointer-events:none;
      transition:all .2s ease;
      z-index:40;
    }
    #toast.show{
      opacity:1;
      transform:translateY(0);
    }

    /*
       ===== MASA DETAY MODALI =====
       Bir masaya tıklayınca açılan misafir listesi paneli
    */
    .table-detail-overlay{
      position:fixed;
      inset:0;
      background:rgba(0,0,0,0.72);
      display:none;
      align-items:center;
      justify-content:center;
      z-index:45;
    }
    .table-detail-overlay.show{
      display:flex;
    }
    .table-detail-card{
      width:min(420px,90%);
      max-height:80vh;
      background:#000000;
      border-radius:18px;
      border:1px solid rgba(148,163,184,0.6);
      box-shadow:0 24px 60px rgba(0,0,0,0.85);
      padding:18px 18px 14px;
      color:#111827;
      display:flex;
      flex-direction:column;
      box-sizing:border-box;
    }
    .table-detail-header{
      display:flex;
      align-items:center;
      justify-content:space-between;
      margin-bottom:10px;
      gap:8px;
    }
    .table-detail-title{
      font-size:16px;
      font-weight:700;
    }
    .table-detail-meta{
      font-size:12px;
      color:#4b5563;
    }
    .table-detail-close{
      border:0;
      border-radius:999px;
      width:28px;
      height:28px;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      cursor:pointer;
      background:rgba(15,23,42,0.9);
      color:var(--muted);
      font-size:16px;
    }
    .table-detail-close:hover{
      background:rgba(31,41,55,1);
      color:var(--fg);
    }
    .table-detail-body{
      font-size:13px;
      color:#4b5563;
      margin-bottom:10px;
    }
    .table-detail-guests{
      flex:1;
      overflow:auto;
      border-radius:12px;
      border:1px solid rgba(31,41,55,0.95);
      background:#000000;
      padding:8px;
      box-sizing:border-box;
    }
    .table-detail-guests-empty{
      font-size:12px;
      color:var(--muted);
      text-align:center;
      padding:12px 4px;
    }
    .table-detail-guest-item{
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding:6px 8px;
      border-radius:10px;
      background:#000000;
      border:1px solid rgba(31,41,55,0.9);
      font-size:12px;
      margin-bottom:6px;
      gap:6px;
      color:#111827;
    }
    .table-detail-guest-main{
      display:flex;
      flex-direction:column;
      gap:2px;
    }
    .table-detail-guest-name{
      font-weight:500;
      color:#000000;
    }
    .table-detail-guest-meta{
      font-size:11px;
      color:#000000;
    }
    .table-detail-guest-count{
      font-size:11px;
      font-weight:600;
      padding:4px 7px;
      border-radius:999px;
      background:rgba(30,64,175,0.55);
      border:1px solid rgba(96,165,250,0.8);
      color:#000000;
      white-space:nowrap;
    }

    /* Küçük ekran */
    @media (max-width:1024px){
      .admin-main{
        flex-direction:column;
        overflow:auto;
      }
      body{
        overflow:auto;
      }
    }
    .mini-table-popup {
      background: #000000;
      color: #111827 !important;
    }
    .mini-table-popup *,
    .mini-table-popup .chip span {
      color: #111827 !important;
    }
    .mini-table-popup .chip {
      background: #000000;
      border-color: #9ca3af;
    }

    /* Tooltip popup for table details */
    #tableTooltip {
      background: #ffffff !important;
      color: #111827 !important;
      border-radius: 10px;
      box-shadow: 0 18px 40px rgba(15,23,42,0.35);
    }
    #tableTooltip * {
      color: #111827 !important;
    }
  </style>

  <script defer src="theme.js"></script>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
  <script>
    var firebaseConfig = {
      apiKey: "AIzaSyChBoQ1PeASYybsUFyZ_iyCKwCgcq2SLPk",
      authDomain: "wedsystem-e080a.firebaseapp.com",
      databaseURL: "https://wedsystem-e080a-default-rtdb.europe-west1.firebasedatabase.app",
      projectId: "wedsystem-e080a",
      storageBucket: "wedsystem-e080a.firebasestorage.app",
      messagingSenderId: "90318782559",
      appId: "1:90318782559:web:374f51b404735c36151bea",
      measurementId: "G-YBXXF4V5RV"
    };
    if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
    window.db = firebase.firestore();
  </script>
</head>

<body class="auth-locked">
  <div class="bg-overlay"></div>

  <div class="admin-shell">
    <!-- NAVBAR -->
    <header class="admin-nav">
      <div class="nav-left">
        <div class="brand-logo"></div>
        <div class="brand-text">DUGUNSEPETI ADMIN</div>

        <nav class="nav-menu">
          <a href="#misafirler" class="nav-link">Misafirler</a>
          <a href="promosyonlar.html" class="nav-link">Promosyonlar</a>
          <a href="vendors.html" class="nav-link">Makyaj &amp; Kuaför</a>
          <a href="vendors.html" class="nav-link">Fotoğraf &amp; Video</a>
          <a href="landing.html#hizmetler" class="nav-link">Hizmetler</a>
          <a href="landing.html" class="nav-link primary">Ürün Sayfası</a>
        </nav>
      </div>

      <div class="nav-login">
        <div>
          <label for="weddingId">Düğün ID</label><br>
          <input id="weddingId" placeholder="örn: kerem-yagmur">
        </div>
        <div>
          <label for="password">Şifre</label><br>
          <input id="password" type="password" placeholder="••••••">
        </div>
        <div style="padding-top:14px">
          <button id="loginBtn">Giriş</button>
        </div>
      </div>
    </header>

    <!-- ANA BÖLÜM -->
    <main class="admin-main">
      <!-- MASA ALANI -->
      <section class="seat-area" aria-label="Oturma Planı">
        <div class="seat-header">
          <div>
            <div class="seat-title">Masa Düzeni</div>
            <div class="seat-sub">
              Misafirleri sağdan sürükleyip masalara bırak. Düğün: <strong><span id="currentWedding">-</span></strong>
            </div>
          </div>
          <div class="seat-actions">
            <button id="loadSeatingBtn" class="btn secondary">Planı Yükle</button>
            <button id="saveSeatingBtn" class="btn primary">Kaydet</button>
          </div>
        </div>

        <div class="seat-grid-wrapper">
          <div style="display:flex; justify-content:space-between; align-items:center;">
            <div style="font-size:12px; color:var(--muted)">
              Toplam kayıt: <b><span id="count">0</span></b> ·
              Evet kişi: <b><span id="sumEvet">0</span></b>
            </div>
            <div style="font-size:11px; color:var(--muted)">
              Salon krokisi üzerinde masaları sürükleyip yerleştirin.
            </div>
          </div>

          <div style="display:flex; justify-content:space-between; align-items:center; margin-top:6px; margin-bottom:6px; font-size:11px; color:var(--muted);">
            <div>Masa ekle / düzenle:</div>
            <div style="display:flex; gap:6px;">
              <button id="addRoundTable" class="btn secondary small" type="button">Yuvarlak Masa</button>
              <button id="addLongTable" class="btn secondary small" type="button">Uzun Masa</button>
              <button id="clearTablesBtn" class="btn secondary small" type="button">Tüm Masaları Sil</button>
            </div>
          </div>

          <div id="dragArea">
            <div id="tablesLayer"></div>
          </div>
        </div>
      </section>

      <!-- MİSAFİR PANELİ -->
      <aside class="guest-panel" id="misafirler">
        <h2>Misafirler</h2>
        <div class="meta">
          RSVP kayıtları; sürükleyip masalara bırak. Gösterilen: <b><span id="countShown">0</span></b> ·
          Kişi (gösterilen): <b><span id="sumShown">0</span></b>
        </div>

        <div class="guest-filters">
          <select id="attFilter">
            <option value="ALL">Durum: Tümü</option>
            <option value="Evet">Yalnızca Evet</option>
            <option value="Hayır">Yalnızca Hayır</option>
          </select>
          <input id="searchBox" placeholder="İsim / Telefon ara">
        </div>

        <div class="guest-actions">
          <button id="refreshBtn">Yenile</button>
          <button id="exportCsvBtn">Masa Düzenini İndir</button>
          <button id="quickSavePlan" class="primary">Planı Kaydet</button>
        </div>

        <div class="guest-scroll">
          <!-- Drag için chip havuzu -->
          <div id="guestPool"></div>

          <!-- Detay listesi (admin.js dolduruyor) -->
          <table id="guestTable">
            <thead>
              <tr>
                <th>Ad Soyad</th>
                <th>Tel</th>
                <th>Durum</th>
                <th>Kişi</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>

        <div class="wa-box">
          <span>Davet linkini WhatsApp ile paylaş:</span>
          <button id="waInviteBtn" type="button">WhatsApp Aç</button>
          <button id="copyInviteBtn" type="button">Linki Kopyala</button>
        </div>

        <div style="margin-top:6px; font-size:11px; color:var(--muted); word-break:break-all;">
          Link: <code id="rsvpLink">(weddingId seçildiğinde)</code>
        </div>
      </aside>
    </main>
  </div>

  <!-- MASA DETAY MODALI (HTML) -->
  <div id="tableDetailOverlay" class="table-detail-overlay" aria-hidden="true">
    <div class="table-detail-card" role="dialog" aria-modal="true" aria-labelledby="tableDetailTitle">
      <div class="table-detail-header">
        <div>
          <div id="tableDetailTitle" class="table-detail-title">Masa -</div>
          <div id="tableDetailMeta" class="table-detail-meta">Toplam kişi: 0</div>
        </div>
        <button type="button" id="tableDetailClose" class="table-detail-close" aria-label="Kapat">×</button>
      </div>
      <div class="table-detail-body">
        Bu masaya atanmış misafirler burada listelenir. Misafirleri sağ panelden sürükleyip bu masaya bırakabilirsiniz.
      </div>
      <div id="tableDetailGuests" class="table-detail-guests">
        <div class="table-detail-guests-empty">
          Bu masaya henüz misafir atanmadı.
        </div>
      </div>
    </div>
  </div>
  <div id="toast"></div>

  <script>
    // Basit toast helper (admin.js ile çakışmaz)
    (function(){
      const toast = document.getElementById('toast');
      window.showToast = function(msg){
        if(!toast) return;
        toast.textContent = msg;
        toast.classList.add('show');
        setTimeout(()=> toast.classList.remove('show'), 1800);
      };
    })();
  </script>

  <script>
    (function(){
      const tablesLayer = document.getElementById('tablesLayer');
      
      let tableCounter = 0;
      const tableEls = new Map();

      function getActiveWeddingId() {
        const span = document.getElementById('currentWedding');
        if (!span) return null;
        const v = (span.textContent || '').trim();
        return v && v !== '-' ? v : null;
      }

      function makeDraggable(el, data) {
        let startX, startY, originLeft, originTop, isDown = false;

        el.addEventListener('mousedown', (ev) => {
          isDown = true;
          el.style.cursor = 'grabbing';
          startX = ev.clientX;
          startY = ev.clientY;
          const rect = el.getBoundingClientRect();
          const parentRect = tablesLayer.getBoundingClientRect();
          originLeft = rect.left - parentRect.left;
          originTop = rect.top - parentRect.top;
          ev.preventDefault();
        });

        document.addEventListener('mousemove', (ev) => {
          if (!isDown) return;
          const dx = ev.clientX - startX;
          const dy = ev.clientY - startY;
          const newLeft = originLeft + dx;
          const newTop = originTop + dy;
          el.style.left = newLeft + 'px';
          el.style.top = newTop + 'px';
        });

        document.addEventListener('mouseup', async () => {
          if (!isDown) return;
          isDown = false;
          el.style.cursor = 'grab';
          const w = getActiveWeddingId();
          if (!w || !data.id) return;
          const rect = el.getBoundingClientRect();
          const parentRect = tablesLayer.getBoundingClientRect();
          const x = rect.left - parentRect.left;
          const y = rect.top - parentRect.top;
          try {
            await db.collection('weddings')
              .doc(w)
              .collection('layout')
              .doc(data.id)
              .update({ x, y });
          } catch (e) {
            console.error(e);
            window.showToast && showToast('Masa konumu kaydedilemedi');
          }
        });
      }

      function renderTable(docId, data) {
        const el = document.createElement('div');
        el.className = 'table-node ' + (data.type === 'long' ? 'long' : 'round');
        el.textContent = data.tableNumber || '?';
        el.style.left = (data.x || 40) + 'px';
        el.style.top  = (data.y || 40) + 'px';
        el.title = 'Masa ' + (data.tableNumber || '') + ' · Kapasite: ' + (data.capacity || '?');
        tablesLayer.appendChild(el);
        tableEls.set(docId, el);
        makeDraggable(el, { id: docId });

        // sağ tık ile masa silme
        el.addEventListener('contextmenu', async (ev) => {
          ev.preventDefault();
          const w = getActiveWeddingId();
          if (!w) return;
          if (!confirm('Bu masayı silmek istiyor musun?')) return;
          try {
            await db.collection('weddings')
              .doc(w)
              .collection('layout')
              .doc(docId)
              .delete();
            tablesLayer.removeChild(el);
            tableEls.delete(docId);
          } catch (e) {
            console.error(e);
            window.showToast && showToast('Masa silinemedi');
          }
        });
      }

      async function loadTablesFor(weddingId) {
        tableEls.forEach(el => el.remove());
        tableEls.clear();
        tableCounter = 0;
        try {
          const snap = await db.collection('weddings')
            .doc(weddingId)
            .collection('layout')
            .get();
          snap.forEach(doc => {
            const data = doc.data() || {};
            if (typeof data.tableNumber === 'number' && data.tableNumber > tableCounter) {
              tableCounter = data.tableNumber;
            }
            renderTable(doc.id, data);
          });
        } catch (e) {
          console.error(e);
          window.showToast && showToast('Masalar yüklenemedi');
        }
      }

      async function addTable(type) {
        const w = getActiveWeddingId();
        if (!w) {
          window.showToast && showToast('Önce düğün seç / giriş yap');
          return;
        }
        tableCounter += 1;
        const base = {
          tableNumber: tableCounter,
          type,
          capacity: type === 'long' ? 24 : 10,
          x: 60 + (tableCounter * 24) % 260,
          y: 60 + (tableCounter * 18) % 180,
          createdAt: firebase.firestore.FieldValue.serverTimestamp()
        };
        try {
          const ref = await db.collection('weddings')
            .doc(w)
            .collection('layout')
            .add(base);
          renderTable(ref.id, base);
          window.showToast && showToast('Masa #' + tableCounter + ' eklendi');
        } catch (e) {
          console.error(e);
          window.showToast && showToast('Masa eklenemedi');
          tableCounter -= 1;
        }
      }

      async function clearTables() {
        const w = getActiveWeddingId();
        if (!w) {
          window.showToast && showToast('Önce düğün seç / giriş yap');
          return;
        }
        if (!confirm('Tüm masaları silmek istiyor musun?')) return;
        try {
          const snap = await db.collection('weddings')
            .doc(w)
            .collection('layout')
            .get();
          const batch = db.batch();
          snap.forEach(doc => batch.delete(doc.ref));
          await batch.commit();
          tableEls.forEach(el => el.remove());
          tableEls.clear();
          tableCounter = 0;
          window.showToast && showToast('Tüm masalar silindi');
        } catch (e) {
          console.error(e);
          window.showToast && showToast('Temizlenemedi');
        }
      }

      document.getElementById('addRoundTable')?.addEventListener('click', () => addTable('round'));
      document.getElementById('addLongTable')?.addEventListener('click', () => addTable('long'));
      document.getElementById('clearTablesBtn')?.addEventListener('click', clearTables);

      const currentWeddingSpan = document.getElementById('currentWedding');
      if (currentWeddingSpan) {
        const obs = new MutationObserver(() => {
          const w = getActiveWeddingId();
          if (w) loadTablesFor(w);
        });
        obs.observe(currentWeddingSpan, { childList: true });
      }
    })();
  </script>

  <script src="admin.js"></script>
</body>
</html>