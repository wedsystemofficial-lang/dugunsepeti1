<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <title>Promosyonlar — DugunSepeti</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="description" content="DugunSepeti promosyonlar ve masa süsleme siparişleri.">

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg:#050815;
      --bg-soft:#0b1020;
      --fg:#f9fafb;
      --muted:#9ca3af;
      --accent:#fbbf24;
      --accent-soft:rgba(251,191,36,0.18);
      --border:#1f2937;
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family:Inter, system-ui, -apple-system, "Segoe UI", sans-serif;
      color:var(--fg);
      background:#000 url("img/landing-bg.jpg") center center/cover fixed no-repeat;
    }

    .overlay{
      position:fixed;
      inset:0;
      background:radial-gradient(circle at 10% 0%, rgba(251,191,36,0.16), transparent 55%),
                 radial-gradient(circle at 90% 40%, rgba(59,130,246,0.2), transparent 60%),
                 linear-gradient(180deg, rgba(0,0,0,0.88), rgba(0,0,0,0.96));
      z-index:-1;
    }

    .shell{
      min-height:100vh;
      display:flex;
      flex-direction:column;
    }

    header{
      height:64px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding:0 22px;
      background:rgba(5,8,21,0.94);
      border-bottom:1px solid rgba(31,41,55,0.9);
      backdrop-filter:blur(16px) saturate(160%);
    }

    .brand{
      display:flex;
      align-items:center;
      gap:10px;
      font-weight:800;
      letter-spacing:.05em;
      text-transform:uppercase;
      font-size:13px;
    }
    .brand-dot{
      width:22px;
      height:22px;
      border-radius:8px;
      background:radial-gradient(circle at 25% 20%, #fef3c7, #fbbf24);
      box-shadow:0 0 16px rgba(251,191,36,0.9);
      position:relative;
    }
    .brand-dot::after{
      content:"";
      position:absolute;
      inset:3px;
      border-radius:7px;
      border:1px solid rgba(255,255,255,0.5);
    }

    .nav-links{
      display:flex;
      align-items:center;
      gap:10px;
      font-size:13px;
    }
    .nav-links a{
      color:var(--muted);
      text-decoration:none;
      padding:6px 10px;
      border-radius:999px;
      border:1px solid transparent;
      background:transparent;
    }
    .nav-links a:hover{
      color:var(--fg);
      border-color:rgba(148,163,184,0.7);
      background:rgba(15,23,42,0.9);
    }

    .nav-links .primary{
      background:var(--accent);
      color:#111827;
      box-shadow:0 10px 26px rgba(251,191,36,0.45);
      border-color:transparent;
      font-weight:600;
    }

    .nav-right{
      font-size:12px;
      color:var(--muted);
    }
    .nav-right b{color:var(--fg)}

    main{
      flex:1;
      padding:20px;
      display:flex;
      justify-content:center;
    }

    .grid{
      width:100%;
      max-width:1080px;
      display:grid;
      grid-template-columns:minmax(0,1.4fr) minmax(0,1.6fr);
      gap:18px;
    }

    .card{
      background:rgba(15,23,42,0.96);
      border-radius:18px;
      border:1px solid rgba(31,41,55,0.95);
      box-shadow:0 24px 60px rgba(0,0,0,0.85);
      padding:18px 18px 16px;
      backdrop-filter:blur(18px) saturate(150%);
    }

    h1,h2,h3{
      margin:0 0 6px;
    }

    .muted{color:var(--muted); font-size:13px}

    .product-hero{
      display:flex;
      flex-direction:column;
      gap:14px;
    }

    .badge{
      display:inline-flex;
      align-items:center;
      gap:6px;
      padding:4px 8px;
      border-radius:999px;
      border:1px solid rgba(251,191,36,0.7);
      background:var(--accent-soft);
      color:var(--accent);
      font-size:11px;
      font-weight:600;
      text-transform:uppercase;
      letter-spacing:.05em;
    }

    .price-line{
      font-size:14px;
      margin-top:4px;
    }
    .price-line b{color:var(--accent)}

    .rose-preview{
      margin-top:8px;
      border-radius:14px;
      border:1px solid rgba(55,65,81,0.9);
      background:radial-gradient(circle at 15% 0, rgba(251,113,133,0.15), transparent 55%),
                 radial-gradient(circle at 90% 90%, rgba(59,130,246,0.16), transparent 55%),
                 #020617;
      padding:14px;
      display:flex;
      gap:10px;
      align-items:center;
    }

    .rose-circle{
      width:48px;
      height:48px;
      border-radius:50%;
      background:radial-gradient(circle at 30% 30%, #fecaca, #fb7185);
      box-shadow:0 0 20px rgba(248,113,113,0.7);
      border:2px solid rgba(248,250,252,0.7);
    }

    .form-grid{
      display:grid;
      grid-template-columns:repeat(2, minmax(0,1fr));
      gap:10px;
      margin-top:10px;
    }
    label{font-size:12px; font-weight:600}

    input[type="text"], input[type="number"], select{
      width:100%;
      margin-top:4px;
      padding:7px 9px;
      border-radius:999px;
      border:1px solid rgba(55,65,81,0.9);
      background:#020617;
      color:var(--fg);
      font-size:13px;
      outline:none;
    }

    input:focus, select:focus{
      border-color:var(--accent);
      box-shadow:0 0 0 2px rgba(251,191,36,0.25);
    }

    .full-row{grid-column:1 / -1}

    .btn{
      padding:9px 12px;
      border-radius:999px;
      border:1px solid rgba(55,65,81,0.95);
      background:rgba(15,23,42,1);
      color:var(--fg);
      font-size:13px;
      cursor:pointer;
    }
    .btn.primary{
      border-color:transparent;
      background:linear-gradient(135deg,#22c55e,#16a34a);
      box-shadow:0 16px 36px rgba(22,163,74,0.5);
      font-weight:600;
    }

    .btn.secondary{
      background:rgba(15,23,42,0.9);
    }

    .btn-row{
      display:flex;
      gap:8px;
      margin-top:12px;
    }

    /* Sepet */
    .cart-header{
      display:flex;
      justify-content:space-between;
      align-items:center;
      margin-bottom:6px;
    }

    .cart-total{
      font-size:14px;
    }
    .cart-total b{color:var(--accent)}

    table{
      width:100%;
      border-collapse:collapse;
      font-size:12px;
    }
    th,td{
      padding:6px 6px;
      border-bottom:1px solid rgba(31,41,55,0.9);
      text-align:left;
    }
    th{color:var(--muted); font-weight:600; font-size:11px}

    .cart-actions{
      display:flex;
      gap:8px;
      margin-top:10px;
    }

    /* Toast */
    #toast{
      position:fixed;
      right:18px;
      bottom:18px;
      background:rgba(15,23,42,0.98);
      border-radius:12px;
      border:1px solid rgba(55,65,81,0.9);
      padding:8px 11px;
      font-size:13px;
      opacity:0;
      transform:translateY(10px);
      pointer-events:none;
      transition:all .2s ease;
      z-index:50;
    }
    #toast.show{
      opacity:1;
      transform:translateY(0);
    }

    @media (max-width:900px){
      main{
        padding:14px;
      }
      .grid{
        grid-template-columns:minmax(0,1fr);
      }
    }
  </style>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
  <script>
    var firebaseConfig = {
      apiKey: "AIzaSyChBoQ1PeASYybsUFyZ_iyCKwCgcq2SLPk",
      authDomain: "wedsystem-e080a.firebaseapp.com",
      databaseURL: "https://wedsystem-e080a-default-rtdb.europe-west1.firebasedatabase.app",
      projectId: "wedsystem-e080a",
      storageBucket: "wedsystem-e080a.firebasestorage.app",
      messagingSenderId: "90318782559",
      appId: "1:90318782559:web:374f51b404735c36151bea",
      measurementId: "G-YBXXF4V5RV"
    };
    if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
  </script>
</head>

<body>
  <div class="overlay"></div>
  <div class="shell">
    <header>
      <div class="brand">
        <div class="brand-dot"></div>
        <span>DUGUNSEPETI PROMOSYONLAR</span>
      </div>
      <div class="nav-links">
        <a href="admin.html">Admin Paneli</a>
        <a href="landing.html" class="primary">Ürün Sayfası</a>
      </div>
      <div class="nav-right">
        Düğün ID: <b id="navWedding">-</b>
      </div>
    </header>

    <main>
      <div class="grid">
        <!-- SOL: ÜRÜN / FORM -->
        <section class="card product-hero">
          <div>
            <div class="badge">Masa Gülü · Kişi başı 25 TL</div>
            <h1>Masa Gülü Siparişi</h1>
            <p class="muted">Her misafirin önüne yerleştirilecek zarif gül buketleri. Fiyat kişi başı hesaplanır; sistem otomatik olarak toplam tutarı çıkarır.</p>
            <p class="price-line">Birim fiyat: <b>25 TL / kişi</b></p>
          </div>

          <div class="rose-preview">
            <div class="rose-circle"></div>
            <div>
              <h3 style="margin:0 0 4px">Premium gül aranjmanı</h3>
              <p class="muted" style="margin:0;font-size:12px">Kırmızı veya pastel tonlarda, masa konseptine uygun şekilde hazırlanmış VIP masa gülleri.</p>
            </div>
          </div>

          <form id="roseForm">
            <div class="form-grid">
              <div>
                <label for="tableId">Masa</label>
                <input id="tableId" placeholder="Örn: M1, M2..." required>
              </div>
              <div>
                <label for="guestCount">Kişi sayısı (bu masa)</label>
                <input id="guestCount" type="number" min="1" step="1" value="8" required>
              </div>
              <div class="full-row">
                <label for="note">Not (opsiyonel)</label>
                <input id="note" placeholder="Örn: Gelin masası için beyaz gül tercih edilsin.">
              </div>
            </div>

            <div class="btn-row">
              <button type="submit" class="btn primary">Sepete ekle</button>
              <button type="button" id="clearForm" class="btn secondary">Temizle</button>
            </div>
          </form>
          <div style="margin-top:10px; border-top:1px dashed rgba(55,65,81,0.8); padding-top:10px;">
            <p class="muted" style="font-size:12px; margin-bottom:6px;">
              Hepsini tek tıkla halletmek ister misiniz? Tüm masalara standart gül paketi ekleyin.
            </p>
            <button type="button" id="addAllTablesBtn" class="btn secondary" style="width:100%; justify-content:center;">
              Tüm masalara gül ekle (paket — 3000 TL)
            </button>
          </div>
        </section>

        <!-- SAĞ: SEPET -->
        <section class="card">
          <div class="cart-header">
            <div>
              <h2>Sepet</h2>
              <p class="muted">Bu düğüne ait masa gülü siparişleri. Onayladığınızda Firestore'a kaydedilir.</p>
            </div>
            <div class="cart-total">
              Toplam: <b><span id="cartTotal">0</span> TL</b>
            </div>
          </div>

          <div style="max-height:260px; overflow:auto; border-radius:12px; border:1px solid rgba(31,41,55,0.95);">
            <table>
              <thead>
                <tr>
                  <th>Masa</th>
                  <th>Kişi</th>
                  <th>Birim (TL)</th>
                  <th>Toplam (TL)</th>
                  <th></th>
                </tr>
              </thead>
              <tbody id="cartBody">
                <!-- JS ile doldurulacak -->
              </tbody>
            </table>
          </div>

          <div class="cart-actions">
            <button type="button" id="clearCart" class="btn secondary">Sepeti temizle</button>
            <button type="button" id="saveCart" class="btn primary" style="flex:1">Siparişi kaydet</button>
          </div>

          <p class="muted" style="margin-top:10px; font-size:12px; line-height:1.4">
            Ödeme altyapısı (kredi kartı vb.) daha sonra eklenecek. Şimdilik siparişler Firestore'da bu düğüne ait bir promosyon kaydı olarak saklanır.
          </p>
        </section>
      </div>
    </main>
  </div>

  <div id="toast"></div>

  <script>
    const UNIT_PRICE = 25;
const PACKAGE_PRICE = 3000;  // tüm masalar gül paketi
let cart = [];
let currentWeddingId = null;

    function showToast(msg){
      const t = document.getElementById('toast');
      if(!t) return;
      t.textContent = msg;
      t.classList.add('show');
      setTimeout(()=> t.classList.remove('show'), 1800);
    }

    function detectWeddingId(){
      const params = new URLSearchParams(window.location.search);
      const fromQuery = params.get('wedding');
      const fromStorage = localStorage.getItem('currentWeddingId') || localStorage.getItem('weddingId');
      currentWeddingId = fromQuery || fromStorage || null;
      const navSpan = document.getElementById('navWedding');
      if(navSpan){ navSpan.textContent = currentWeddingId || '-'; }
      if(!currentWeddingId){
        showToast('Uyarı: Düğün ID bulunamadı. ?wedding=xxx ile veya admin panelinden açın.');
      }
    }

    function renderCart(){
      const body = document.getElementById('cartBody');
      const totalEl = document.getElementById('cartTotal');
      if(!body || !totalEl) return;
      body.innerHTML = '';
      let total = 0;
      cart.forEach((item, idx)=>{
        const row = document.createElement('tr');
        const lineTotal = item.guestCount * item.unitPrice;
        total += lineTotal;
        row.innerHTML = `
          <td>${item.tableId}</td>
          <td>${item.guestCount}</td>
          <td>${item.unitPrice}</td>
          <td>${lineTotal}</td>
          <td><button type="button" data-idx="${idx}" class="btn secondary" style="font-size:11px;padding:3px 7px;">Sil</button></td>
        `;
        body.appendChild(row);
      });
      totalEl.textContent = total;

      body.querySelectorAll('button[data-idx]').forEach(btn=>{
        btn.addEventListener('click', e=>{
          const i = parseInt(e.currentTarget.getAttribute('data-idx'),10);
          if(!isNaN(i)){
            cart.splice(i,1);
            renderCart();
          }
        });
      });
    }

    async function saveCartToFirestore(){
      if(!currentWeddingId){
        showToast('Önce geçerli bir Düğün ID ile sayfayı açın.');
        return;
      }
      if(!cart.length){
        showToast('Sepet boş.');
        return;
      }
      try{
        const payload = {
          weddingId: currentWeddingId,
          type: 'rose-order',
          unitPrice: UNIT_PRICE,
          currency: 'TRY',
          items: cart.map(c=>({
            tableId: c.tableId,
            guestCount: c.guestCount,
            note: c.note || null,
            total: c.guestCount * c.unitPrice,
          })),
          totalAmount: cart.reduce((sum, c)=> sum + c.guestCount * c.unitPrice, 0),
          createdAt: firebase.firestore.FieldValue.serverTimestamp(),
        };

        await db
          .collection('weddings')
          .doc(currentWeddingId)
          .collection('promotions')
          .add(payload);

        showToast('Sipariş Firestore\'a kaydedildi.');
        cart = [];
        renderCart();
      }catch(err){
        console.error(err);
        alert('Sipariş kaydedilirken hata oluştu: ' + err.message);
      }
    }

    window.addEventListener('DOMContentLoaded', () => {
  detectWeddingId();

  const form = document.getElementById('roseForm');
  const clearFormBtn = document.getElementById('clearForm');
  const clearCartBtn = document.getElementById('clearCart');
  const saveCartBtn = document.getElementById('saveCart');
  const addAllTablesBtn = document.getElementById('addAllTablesBtn');

      if(form){
        form.addEventListener('submit', e => {
          e.preventDefault();
          const tableId = document.getElementById('tableId').value.trim();
          const guestCountValue = document.getElementById('guestCount').value;
          const note = document.getElementById('note').value.trim();

          const guestCount = parseInt(guestCountValue, 10);

          if(!tableId || !guestCount || guestCount < 1){
            showToast('Lütfen masa ve kişi sayısını doğru girin.');
            return;
          }

          cart.push({
            tableId,
            guestCount,
            unitPrice: UNIT_PRICE,
            note,
          });

          renderCart();
          showToast('Sepete eklendi.');
        });
      }

      if(clearFormBtn){
        clearFormBtn.addEventListener('click', () => {
          document.getElementById('tableId').value = '';
          document.getElementById('guestCount').value = 8;
          document.getElementById('note').value = '';
        });
      }

      if(clearCartBtn){
        clearCartBtn.addEventListener('click', () => {
          cart = [];
          renderCart();
          showToast('Sepet temizlendi.');
        });
      }

      if(saveCartBtn){
        saveCartBtn.addEventListener('click', saveCartToFirestore);
      }
    });
  </script>
</body>
</html>